'use client'

import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Loader2, Users, TrendingUp, Eye, Clock, Target, Brain, BarChart3 } from 'lucide-react'
import { apiClient, RecommendationResult, UserProfile, ReadingPatterns, RecommendationAnalytics } from '@/lib/api'
import UserList from './user-list'

interface RecommendationManagerProps {
  language?: string
}

const RecommendationManager: React.FC<RecommendationManagerProps> = ({ language = 'en' }) => {
  const [activeTab, setActiveTab] = useState('overview')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [popularContent, setPopularContent] = useState<RecommendationResult[]>([])
  const [selectedUserId, setSelectedUserId] = useState('')
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null)
  const [readingPatterns, setReadingPatterns] = useState<ReadingPatterns | null>(null)
  const [analytics, setAnalytics] = useState<RecommendationAnalytics | null>(null)
  const [similarUsers, setSimilarUsers] = useState<string[]>([])

  // Multilingual text helper
  const t = (key: string): string => {
    const texts: Record<string, Record<string, string>> = {
      title: {
        zh: '‰∏™ÊÄßÂåñÊé®ËçêÁ≥ªÁªü',
        en: 'Personalized Recommendation System',
        ja: '„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„ÉâÊé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†'
      },
      subtitle: {
        zh: 'ÁÆ°ÁêÜÂíåÂàÜÊûêÁî®Êà∑Ë°å‰∏∫Ôºå‰ºòÂåñÂÜÖÂÆπÊé®Ëçê',
        en: 'Manage and analyze user behavior, optimize content recommendations',
        ja: '„É¶„Éº„Ç∂„ÉºË°åÂãï„ÇíÁÆ°ÁêÜ„ÉªÂàÜÊûê„Åó„ÄÅ„Ç≥„É≥„ÉÜ„É≥„ÉÑÊé®Ëñ¶„ÇíÊúÄÈÅ©Âåñ'
      },
      refreshData: {
        zh: 'Âà∑Êñ∞Êï∞ÊçÆ',
        en: 'Refresh Data',
        ja: '„Éá„Éº„Çø„ÇíÊõ¥Êñ∞'
      },
      overview: {
        zh: 'Ê¶ÇËßà',
        en: 'Overview',
        ja: 'Ê¶ÇË¶Å'
      },
      popularContent: {
        zh: 'ÁÉ≠Èó®ÂÜÖÂÆπ',
        en: 'Popular Content',
        ja: '‰∫∫Ê∞ó„Ç≥„É≥„ÉÜ„É≥„ÉÑ'
      },
      userAnalysis: {
        zh: 'Áî®Êà∑ÂàÜÊûê',
        en: 'User Analysis',
        ja: '„É¶„Éº„Ç∂„ÉºÂàÜÊûê'
      },
      analyticsReport: {
        zh: 'ÂàÜÊûêÊä•Âëä',
        en: 'Analytics Report',
        ja: 'ÂàÜÊûê„É¨„Éù„Éº„Éà'
      },
      systemStatus: {
        zh: 'Êé®ËçêÁ≥ªÁªüÁä∂ÊÄÅ',
        en: 'Recommendation System Status',
        ja: 'Êé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã'
      },
      running: {
        zh: 'ËøêË°å‰∏≠',
        en: 'Running',
        ja: 'Á®ºÂÉç‰∏≠'
      },
      multiAlgorithm: {
        zh: 'Â§öÁÆóÊ≥ïÊô∫ËÉΩÊé®Ëçê',
        en: 'Multi-algorithm intelligent recommendations',
        ja: '„Éû„É´„ÉÅ„Ç¢„É´„Ç¥„É™„Ç∫„É†Áü•ËÉΩÊé®Ëñ¶'
      },
      trendingContent7Days: {
        zh: 'ËøáÂéª7Â§©ÁöÑË∂ãÂäøÂÜÖÂÆπ',
        en: 'Trending content from past 7 days',
        ja: 'ÈÅéÂéª7Êó•Èñì„ÅÆ„Éà„É¨„É≥„Éâ„Ç≥„É≥„ÉÜ„É≥„ÉÑ'
      },
      algorithms: {
        zh: 'Êé®ËçêÁÆóÊ≥ï',
        en: 'Recommendation Algorithms',
        ja: 'Êé®Ëñ¶„Ç¢„É´„Ç¥„É™„Ç∫„É†'
      },
      algorithmTypes: {
        zh: 'ÂÜÖÂÆπ„ÄÅÂçèÂêå„ÄÅË∂ãÂäø„ÄÅÊé¢Á¥¢',
        en: 'Content, Collaborative, Trending, Discovery',
        ja: '„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÄÅÂçîË™ø„ÄÅ„Éà„É¨„É≥„Éâ„ÄÅÁô∫Ë¶ã'
      },
      cacheEfficiency: {
        zh: 'ÁºìÂ≠òÊïàÁéá',
        en: 'Cache Efficiency',
        ja: '„Ç≠„É£„ÉÉ„Ç∑„É•ÂäπÁéá'
      },
      efficient: {
        zh: 'È´òÊïà',
        en: 'Efficient',
        ja: 'ÂäπÁéáÁöÑ'
      },
      threeTierCache: {
        zh: '‰∏âÂ±ÇÁºìÂ≠òÁ≥ªÁªü',
        en: 'Three-tier cache system',
        ja: '3Â±§„Ç≠„É£„ÉÉ„Ç∑„É•„Ç∑„Çπ„ÉÜ„É†'
      },
      systemOverview: {
        zh: 'Á≥ªÁªüÊ¶ÇËø∞',
        en: 'System Overview',
        ja: '„Ç∑„Çπ„ÉÜ„É†Ê¶ÇË¶Å'
      },
      systemDescription: {
        zh: '‰∏™ÊÄßÂåñÊé®ËçêÁ≥ªÁªüÈÄöËøáÂàÜÊûêÁî®Êà∑Ë°å‰∏∫„ÄÅÊñáÁ´†ÂÜÖÂÆπÂíåÁ§æ‰∫§‰ø°Âè∑Ôºå‰∏∫ÊØè‰∏™Áî®Êà∑Êèê‰æõÊúÄÁõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÊé®Ëçê„ÄÇ',
        en: 'The personalized recommendation system analyzes user behavior, article content, and social signals to provide the most relevant content recommendations for each user.',
        ja: '„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„ÉâÊé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†„ÅØ„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆË°åÂãï„ÄÅË®ò‰∫ã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÄÅ„ÇΩ„Éº„Ç∑„É£„É´„Ç∑„Ç∞„Éä„É´„ÇíÂàÜÊûê„Åó„ÄÅÂêÑ„É¶„Éº„Ç∂„Éº„Å´ÊúÄ„ÇÇÈñ¢ÈÄ£ÊÄß„ÅÆÈ´ò„ÅÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑÊé®Ëñ¶„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ'
      },
      recommendationAlgorithms: {
        zh: 'Êé®ËçêÁÆóÊ≥ï',
        en: 'Recommendation Algorithms',
        ja: 'Êé®Ëñ¶„Ç¢„É´„Ç¥„É™„Ç∫„É†'
      },
      dataSources: {
        zh: 'Êï∞ÊçÆÊ∫ê',
        en: 'Data Sources',
        ja: '„Éá„Éº„Çø„ÇΩ„Éº„Çπ'
      },
      popularRecommendations: {
        zh: 'ÁÉ≠Èó®Êé®ËçêÂÜÖÂÆπ',
        en: 'Popular Recommended Content',
        ja: '‰∫∫Ê∞óÊé®Ëñ¶„Ç≥„É≥„ÉÜ„É≥„ÉÑ'
      },
      popularDescription: {
        zh: 'Âü∫‰∫éÁî®Êà∑‰∫íÂä®ÂíåÈòÖËØªÊï∞ÊçÆÁöÑË∂ãÂäøÂÜÖÂÆπÔºåÊåâÊé®ËçêÁΩÆ‰ø°Â∫¶ÊéíÂ∫è',
        en: 'Trending content based on user interaction and reading data, sorted by recommendation confidence',
        ja: '„É¶„Éº„Ç∂„Éº„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„Å®Ë™≠„ÅøÂèñ„Çä„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Åü„Éà„É¨„É≥„Éâ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÄÅÊé®Ëñ¶‰ø°È†ºÂ∫¶È†Ü„Å´„ÇΩ„Éº„Éà'
      },
      userBehaviorAnalysis: {
        zh: 'Áî®Êà∑Ë°å‰∏∫ÂàÜÊûê',
        en: 'User Behavior Analysis',
        ja: '„É¶„Éº„Ç∂„ÉºË°åÂãïÂàÜÊûê'
      },
      recommendationEffectAnalysis: {
        zh: 'Êé®ËçêÊïàÊûúÂàÜÊûê',
        en: 'Recommendation Effect Analysis',
        ja: 'Êé®Ëñ¶ÂäπÊûúÂàÜÊûê'
      }
    }
    
    return texts[key]?.[language] || texts[key]?.['en'] || key
  }

  // Load popular content on component mount
  useEffect(() => {
    loadPopularContent()
  }, [language])

  const loadPopularContent = async () => {
    try {
      setLoading(true)
      const response = await apiClient.getPopularContent({
        language,
        limit: 10,
        days: 7
      })
      setPopularContent(response.popular_content)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load popular content')
    } finally {
      setLoading(false)
    }
  }

  const loadUserProfile = async (userId: string) => {
    if (!userId.trim()) return
    
    try {
      setLoading(true)
      setError(null)
      
      const [profileResponse, patternsResponse, analyticsResponse, similarResponse] = await Promise.allSettled([
        apiClient.getUserProfile(userId),
        apiClient.getUserReadingPatterns(userId, 30),
        apiClient.getRecommendationAnalytics(userId, 30),
        apiClient.getSimilarUsers(userId, 5)
      ])

      if (profileResponse.status === 'fulfilled') {
        setUserProfile(profileResponse.value.profile)
      } else {
        console.warn('Failed to load user profile:', profileResponse.reason)
      }

      if (patternsResponse.status === 'fulfilled') {
        setReadingPatterns(patternsResponse.value.patterns)
      } else {
        console.warn('Failed to load reading patterns:', patternsResponse.reason)
      }

      if (analyticsResponse.status === 'fulfilled') {
        setAnalytics(analyticsResponse.value.analytics)
      } else {
        console.warn('Failed to load analytics:', analyticsResponse.reason)
      }

      if (similarResponse.status === 'fulfilled') {
        setSimilarUsers(similarResponse.value.similar_users)
      } else {
        console.warn('Failed to load similar users:', similarResponse.reason)
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load user data')
    } finally {
      setLoading(false)
    }
  }

  const handleUserSelect = (userId: string) => {
    setSelectedUserId(userId)
    loadUserProfile(userId)
  }

  const formatReadingTime = (seconds: number): string => {
    const minutes = Math.round(seconds / 60)
    if (minutes < 60) return `${minutes}m`
    const hours = Math.round(minutes / 60)
    return `${hours}h ${minutes % 60}m`
  }

  const formatConfidence = (confidence: number): string => {
    return `${Math.round(confidence * 100)}%`
  }

  const getRecommendationTypeColor = (type: string): string => {
    switch (type) {
      case 'content_based': return 'bg-blue-100 text-blue-800'
      case 'collaborative': return 'bg-green-100 text-green-800'
      case 'trending': return 'bg-red-100 text-red-800'
      case 'serendipity': return 'bg-purple-100 text-purple-800'
      case 'learning_path': return 'bg-amber-100 text-amber-800'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  const getRecommendationIcon = (recommendation: RecommendationResult): string => {
    if (recommendation.is_learning_path || recommendation.category === 'learning') {
      return 'üìö'
    }
    switch (recommendation.recommendation_type) {
      case 'content_based': return 'üîó'
      case 'collaborative': return 'üë•'
      case 'trending': return 'üî•'
      case 'serendipity': return 'üåü'
      default: return 'üìÑ'
    }
  }

  const getRecommendationCategoryLabel = (recommendation: RecommendationResult, language: string): string => {
    if (recommendation.is_learning_path || recommendation.category === 'learning') {
      if (language === 'zh') return 'Â≠¶‰π†Ë∑ØÂæÑ'
      if (language === 'ja') return 'Â≠¶Áøí„Éë„Çπ'
      return 'Learning Path'
    }
    if (language === 'zh') return 'Êô∫ËÉΩÊé®Ëçê'
    if (language === 'ja') return '„Çπ„Éû„Éº„ÉàÊé®Ëñ¶'
    return 'Discovery'
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">{t('title')}</h1>
          <p className="text-gray-600">{t('subtitle')}</p>
        </div>
        <Button onClick={loadPopularContent} disabled={loading}>
          {loading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
          {t('refreshData')}
        </Button>
      </div>

      {error && (
        <Alert variant="destructive">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="overview">{t('overview')}</TabsTrigger>
          <TabsTrigger value="popular">{t('popularContent')}</TabsTrigger>
          <TabsTrigger value="users">{t('userAnalysis')}</TabsTrigger>
          <TabsTrigger value="analytics">{t('analyticsReport')}</TabsTrigger>
        </TabsList>

        <TabsContent value="overview" className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">{t('systemStatus')}</CardTitle>
                <Brain className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold text-green-600">{t('running')}</div>
                <p className="text-xs text-muted-foreground">
                  {t('multiAlgorithm')}
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">{t('popularContent')}</CardTitle>
                <TrendingUp className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{popularContent.length}</div>
                <p className="text-xs text-muted-foreground">
                  {t('trendingContent7Days')}
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">{t('algorithms')}</CardTitle>
                <Target className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">4</div>
                <p className="text-xs text-muted-foreground">
                  {t('algorithmTypes')}
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">{t('cacheEfficiency')}</CardTitle>
                <BarChart3 className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold text-blue-600">{t('efficient')}</div>
                <p className="text-xs text-muted-foreground">
                  {t('threeTierCache')}
                </p>
              </CardContent>
            </Card>
          </div>

          <Card>
            <CardHeader>
              <CardTitle>{t('systemOverview')}</CardTitle>
              <CardDescription>
                {t('systemDescription')}
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h4 className="font-semibold mb-2">{t('recommendationAlgorithms')}</h4>
                  <ul className="space-y-1 text-sm text-gray-600">
                    {language === 'zh' ? (
                      <>
                        <li>‚Ä¢ Âü∫‰∫éÂÜÖÂÆπÁöÑÊé®ËçêÔºàÊñáÁ´†Áõ∏‰ººÊÄßÔºâ</li>
                        <li>‚Ä¢ ÂçèÂêåËøáÊª§ÔºàÁõ∏‰ººÁî®Êà∑ÂñúÂ•ΩÔºâ</li>
                        <li>‚Ä¢ Ë∂ãÂäøÂÜÖÂÆπÊé®ËçêÔºàÁÉ≠Èó®ÊñáÁ´†Ôºâ</li>
                        <li>‚Ä¢ Êé¢Á¥¢ÊÄßÊé®ËçêÔºàÂ§öÊ†∑ÂåñÂÜÖÂÆπÔºâ</li>
                      </>
                    ) : language === 'ja' ? (
                      <>
                        <li>‚Ä¢ „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éô„Éº„ÇπÊé®Ëñ¶ÔºàË®ò‰∫ãÈ°û‰ººÊÄßÔºâ</li>
                        <li>‚Ä¢ ÂçîË™ø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÈ°û‰ºº„É¶„Éº„Ç∂„Éº„ÅÆÂ•Ω„ÅøÔºâ</li>
                        <li>‚Ä¢ „Éà„É¨„É≥„Éâ„Ç≥„É≥„ÉÜ„É≥„ÉÑÊé®Ëñ¶Ôºà‰∫∫Ê∞óË®ò‰∫ãÔºâ</li>
                        <li>‚Ä¢ Êé¢Á¥¢ÁöÑÊé®Ëñ¶ÔºàÂ§öÊßò„Å™„Ç≥„É≥„ÉÜ„É≥„ÉÑÔºâ</li>
                      </>
                    ) : (
                      <>
                        <li>‚Ä¢ Content-based recommendations (article similarity)</li>
                        <li>‚Ä¢ Collaborative filtering (similar user preferences)</li>
                        <li>‚Ä¢ Trending content recommendations (popular articles)</li>
                        <li>‚Ä¢ Exploratory recommendations (diverse content)</li>
                      </>
                    )}
                  </ul>
                </div>
                <div>
                  <h4 className="font-semibold mb-2">{t('dataSources')}</h4>
                  <ul className="space-y-1 text-sm text-gray-600">
                    {language === 'zh' ? (
                      <>
                        <li>‚Ä¢ Áî®Êà∑ÈòÖËØªË°å‰∏∫ÂíåÊó∂Èïø</li>
                        <li>‚Ä¢ ÊñáÁ´†ÂêëÈáèÂµåÂÖ•ÂíåÁõ∏‰ººÊÄß</li>
                        <li>‚Ä¢ ÊªöÂä®Ê∑±Â∫¶Âíå‰∫íÂä®Êï∞ÊçÆ</li>
                        <li>‚Ä¢ ËÆæÂ§áÂíåÊó∂Èó¥ÂÅèÂ•Ω</li>
                      </>
                    ) : language === 'ja' ? (
                      <>
                        <li>‚Ä¢ „É¶„Éº„Ç∂„ÉºË™≠„ÅøÂèñ„ÇäË°åÂãï„Å®ÊôÇÈñì</li>
                        <li>‚Ä¢ Ë®ò‰∫ã„Éô„ÇØ„Éà„É´Âüã„ÇÅËæº„Åø„Å®È°û‰ººÊÄß</li>
                        <li>‚Ä¢ „Çπ„ÇØ„É≠„Éº„É´Ê∑±Â∫¶„Å®„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„Éá„Éº„Çø</li>
                        <li>‚Ä¢ „Éá„Éê„Ç§„Çπ„Å®ÊôÇÈñì„ÅÆÂ•Ω„Åø</li>
                      </>
                    ) : (
                      <>
                        <li>‚Ä¢ User reading behavior and duration</li>
                        <li>‚Ä¢ Article vector embeddings and similarity</li>
                        <li>‚Ä¢ Scroll depth and interaction data</li>
                        <li>‚Ä¢ Device and time preferences</li>
                      </>
                    )}
                  </ul>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="popular" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5" />
                {t('popularRecommendations')}
              </CardTitle>
              <CardDescription>
                {t('popularDescription')}
              </CardDescription>
            </CardHeader>
            <CardContent>
              {loading ? (
                <div className="flex items-center justify-center py-8">
                  <Loader2 className="h-8 w-8 animate-spin" />
                  <span className="ml-2">Âä†ËΩΩ‰∏≠...</span>
                </div>
              ) : popularContent.length > 0 ? (
                <div className="space-y-4">
                  {popularContent.map((recommendation, index) => (
                    <div key={recommendation.article.id} className="border rounded-lg p-4 hover:bg-accent">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-sm font-mono text-gray-500">#{index + 1}</span>
                            <span className="text-lg">{getRecommendationIcon(recommendation)}</span>
                            <Badge className={getRecommendationTypeColor(recommendation.recommendation_type)}>
                              {getRecommendationCategoryLabel(recommendation, language)}
                            </Badge>
                            <Badge variant="outline">
                              {language === 'zh' ? 'ÁΩÆ‰ø°Â∫¶' : language === 'ja' ? '‰ø°È†ºÂ∫¶' : 'Confidence'}: {formatConfidence(recommendation.confidence)}
                            </Badge>
                            {(recommendation.is_learning_path || recommendation.category === 'learning') && (
                              <Badge className="bg-amber-50 text-amber-700 border-amber-200">
                                {language === 'zh' ? 'Â≠¶‰π†' : language === 'ja' ? 'Â≠¶Áøí' : 'Learning'}
                              </Badge>
                            )}
                          </div>
                          <h3 className="font-semibold text-lg mb-1">
                            {recommendation.article.title}
                          </h3>
                          <p className="text-gray-600 text-sm mb-2">
                            {recommendation.article.summary}
                          </p>
                          <div className="flex items-center gap-4 text-xs text-gray-500">
                            <span className="flex items-center gap-1">
                              <Eye className="h-3 w-3" />
                              {recommendation.article.view_count || 0} Ê¨°ÊµèËßà
                            </span>
                            <span>
                              ÂàÜÁ±ª: {recommendation.article.category.name}
                            </span>
                          </div>
                        </div>
                      </div>
                      {recommendation.reason_details && (
                        <div className={`mt-2 p-2 rounded text-sm ${
                          recommendation.is_learning_path || recommendation.category === 'learning'
                            ? 'bg-amber-50 text-amber-700'
                            : 'bg-blue-50 text-blue-700'
                        }`}>
                          <strong>
                            {language === 'zh' ? 'Êé®ËçêÁêÜÁî±:' : language === 'ja' ? 'Êé®Ëñ¶ÁêÜÁî±:' : 'Recommendation Reason:'}
                          </strong> {recommendation.reason_details}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  ÊöÇÊó†ÁÉ≠Èó®ÂÜÖÂÆπÊï∞ÊçÆ
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="users" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="h-5 w-5" />
                {t('userBehaviorAnalysis')}
              </CardTitle>
              <CardDescription>
                ËæìÂÖ•Áî®Êà∑IDÂàÜÊûêÂÖ∂ÈòÖËØªË°å‰∏∫ÂíåÂÅèÂ•ΩÊ®°ÂºèÔºåÊàñ‰ªé‰∏ãÊñπÂàóË°®‰∏≠ÈÄâÊã©Áî®Êà∑
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="flex gap-2 mb-6">
                <Input
                  placeholder="ËæìÂÖ•Áî®Êà∑ID (‰æãÂ¶Ç: user_123 Êàñ IPÂú∞ÂùÄ)"
                  value={selectedUserId}
                  onChange={(e) => setSelectedUserId(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      loadUserProfile(selectedUserId)
                    }
                  }}
                />
                <Button 
                  onClick={() => loadUserProfile(selectedUserId)}
                  disabled={!selectedUserId.trim() || loading}
                >
                  ÂàÜÊûê
                </Button>
              </div>

              {/* User List Component */}
              <div className="mb-6">
                <UserList 
                  onUserSelect={handleUserSelect}
                  language={language}
                />
              </div>

              {userProfile && (
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm">ÈòÖËØªÁªüËÆ°</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span>ÊÄªÈòÖËØªÊó∂Èó¥:</span>
                            <span className="font-medium">
                              {formatReadingTime(userProfile.total_reading_time)}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span>ÊñáÁ´†Êï∞Èáè:</span>
                            <span className="font-medium">{userProfile.article_count}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Âπ≥ÂùáÈòÖËØªÊó∂Èó¥:</span>
                            <span className="font-medium">
                              {formatReadingTime(userProfile.avg_reading_time)}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span>ÈòÖËØªÈÄüÂ∫¶:</span>
                            <span className="font-medium">{Math.round(userProfile.reading_speed)} ËØç/ÂàÜÈíü</span>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm">Áî®Êà∑ÂÅèÂ•Ω</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span>‰∏ªË¶ÅËØ≠Ë®Ä:</span>
                            <span className="font-medium">{userProfile.language}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>ËÆæÂ§áÂÅèÂ•Ω:</span>
                            <span className="font-medium">{userProfile.device_preference || 'Êú™Áü•'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Âπ≥ÂùáÊªöÂä®Ê∑±Â∫¶:</span>
                            <span className="font-medium">
                              {Math.round(Math.min(userProfile.avg_scroll_depth, 1.0) * 100)}%
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span>ÊúÄÂêéÊ¥ªË∑É:</span>
                            <span className="font-medium">
                              {new Date(userProfile.last_active).toLocaleDateString()}
                            </span>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-sm">Áõ∏‰ººÁî®Êà∑</CardTitle>
                      </CardHeader>
                      <CardContent>
                        {similarUsers.length > 0 ? (
                          <div className="space-y-1">
                            {similarUsers.map((userId, index) => (
                              <div key={userId} className="text-sm p-1 bg-gray-50 rounded">
                                {userId}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-sm text-gray-500">ÊöÇÊó†Áõ∏‰ººÁî®Êà∑</div>
                        )}
                      </CardContent>
                    </Card>
                  </div>

                  {readingPatterns && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="text-sm">ÈòÖËØªÊ®°ÂºèÂàÜÊûê</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <h4 className="font-semibold mb-2">ËÆæÂ§áÂàÜÂ∏É</h4>
                            <div className="space-y-1">
                              {Object.entries(readingPatterns?.device_distribution || {}).map(([device, count]) => (
                                <div key={device} className="flex justify-between text-sm">
                                  <span>{device}:</span>
                                  <span>{count} Ê¨°</span>
                                </div>
                              ))}
                            </div>
                          </div>
                          <div>
                            <h4 className="font-semibold mb-2">ÂàÜÁ±ªÂÖ¥Ë∂£</h4>
                            <div className="space-y-1">
                              {Object.entries(readingPatterns?.category_interests || {})
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([category, score]) => (
                                  <div key={category} className="flex justify-between text-sm">
                                    <span>{category}:</span>
                                    <span>{score.toFixed(2)}</span>
                                  </div>
                                ))}
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="analytics" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <BarChart3 className="h-5 w-5" />
                {t('recommendationEffectAnalysis')}
              </CardTitle>
              <CardDescription>
                Êé®ËçêÁ≥ªÁªüÁöÑÊÄßËÉΩÊåáÊ†áÂíåÁî®Êà∑ÂèçÈ¶àÂàÜÊûê
              </CardDescription>
            </CardHeader>
            <CardContent>
              {analytics ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="p-4 border rounded-lg">
                    <div className="text-2xl font-bold">{analytics.total_recommendations}</div>
                    <div className="text-sm text-gray-600">ÊÄªÊé®ËçêÊï∞</div>
                  </div>
                  <div className="p-4 border rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">
                      {Math.round(analytics.click_through_rate * 100)}%
                    </div>
                    <div className="text-sm text-gray-600">ÁÇπÂáªÁéá</div>
                  </div>
                  <div className="p-4 border rounded-lg">
                    <div className="text-2xl font-bold text-green-600">
                      {Math.round(analytics.avg_confidence * 100)}%
                    </div>
                    <div className="text-sm text-gray-600">Âπ≥ÂùáÁΩÆ‰ø°Â∫¶</div>
                  </div>
                  <div className="p-4 border rounded-lg">
                    <div className="text-2xl font-bold">
                      {Object.keys(analytics.type_distribution).length}
                    </div>
                    <div className="text-sm text-gray-600">Êé®ËçêÁ±ªÂûã</div>
                  </div>
                </div>
              ) : selectedUserId ? (
                <div className="text-center py-8 text-gray-500">
                  ËØ∑ÂÖàÈÄâÊã©Áî®Êà∑Êü•ÁúãÂàÜÊûêÊï∞ÊçÆ
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  ËØ∑ËæìÂÖ•Áî®Êà∑IDÊü•ÁúãÂàÜÊûêÊï∞ÊçÆ
                </div>
              )}

              {analytics && analytics.type_distribution && (
                <div className="mt-6">
                  <h4 className="font-semibold mb-3">Êé®ËçêÁ±ªÂûãÂàÜÂ∏É</h4>
                  <div className="space-y-2">
                    {Object.entries(analytics?.type_distribution || {}).map(([type, count]) => (
                      <div key={type} className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Badge className={getRecommendationTypeColor(type)}>
                            {type}
                          </Badge>
                        </div>
                        <span className="font-medium">{count}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  )
}

export default RecommendationManager